<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Grid 12x12</title>
  <style>
    .grid-container {
      display: inline-block;
      margin: 20px;
    }
    .row {
      display: flex;
    }
    .cell-btn {
      width: 30px;
      height: 30px;
      margin: 2px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Grid 12x12</h1>
  
  <!-- Sección para ingresar el API Token -->
  <div>
    <label for="apiToken">Ingrese su API Token: </label>
    <input type="text" id="apiToken" placeholder="API Token" />
    <button onclick="setApiToken()">Guardar Token</button>
  </div>

  <div id="grid" class="grid-container"></div>

  <script>
    const repoOwner = 'maraloaven'; // Nombre de usuario de GitHub
    const repoName = 'Down2Earth_UI'; // Nombre del repositorio
    const filePath = 'buttonStates.txt'; // Ruta del archivo dentro de tu repositorio
    let token = ''; // Variable para almacenar el token de acceso personal

    // Un diccionario para almacenar el estado de los botones
    let buttonStates = {};

    // Función para actualizar el archivo en GitHub
    function updateGitHubFile() {
      if (!token) {
        alert("Por favor, ingrese un token válido.");
        return;
      }

      const content = generateFileContent();

      const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

      // Obtener información del archivo existente para obtener el SHA
      fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `token ${token}`,
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Error al obtener el archivo: ' + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        const sha = data.sha; // Obtener el SHA del archivo actual

        // Luego actualizamos el archivo
        fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: 'Actualizar estado de botones',
            content: btoa(content), // Codificar el contenido en base64
            sha: sha, // SHA del archivo actual
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Error al actualizar el archivo: ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          console.log('Archivo actualizado:', data);
        })
        .catch(error => {
          console.error('Error al actualizar el archivo:', error);
        });
      })
      .catch(error => {
        console.error('Error al obtener el archivo:', error);
      });
    }

    // Función para generar el contenido del archivo `.txt`
    function generateFileContent() {
      let content = '';
      for (let row = 0; row < 12; row++) {
        for (let col = 0; col < 12; col++) {
          const buttonId = `${row}_${col}`; // Reemplazamos la coma por un guion bajo
          content += `Button ${buttonId}: ${buttonStates[buttonId] || 0}\n`;
        }
      }
      return content;
    }

    // Función para manejar los clics en los botones
    function handleButtonClick(row, col) {
      const buttonId = `${row}_${col}`; // Reemplazamos la coma por un guion bajo

      // Cambiar el estado del botón (de 0 a 1 o de 1 a 0)
      buttonStates[buttonId] = buttonStates[buttonId] === 1 ? 0 : 1;

      // Actualizar el color del botón
      const button = document.querySelector(`#button-${buttonId}`);
      button.style.backgroundColor = buttonStates[buttonId] === 1 ? 'green' : 'red';

      // Actualizar el archivo `.txt` en GitHub
      updateGitHubFile();
    }

    // Genera la cuadrícula 12x12
    function createGrid() {
      const gridContainer = document.getElementById("grid");

      for (let row = 0; row < 12; row++) {
        const rowDiv = document.createElement("div");
        rowDiv.className = "row";
        
        for (let col = 0; col < 12; col++) {
          const button = document.createElement("button");
          button.className = "cell-btn";
          button.id = `button-${row}_${col}`; // Reemplazamos la coma por un guion bajo
          button.textContent = `${row},${col}`;

          // Añadir listener para el clic
          button.addEventListener('click', function() {
            handleButtonClick(row, col);
          });

          rowDiv.appendChild(button);
        }

        gridContainer.appendChild(rowDiv);
      }
    }

    // Función para guardar el API token introducido por el usuario
    function setApiToken() {
      token = document.getElementById('apiToken').value;
      if (!token) {
        alert("Por favor, ingrese un API token.");
      } else {
        alert("API token guardado correctamente.");
      }
    }

    createGrid();
  </script>
</body>
</html>
